<div class="terraria-container">
  <div class="terraria-header">
    <span class="material-icons terraria-icon">sports_esports</span>
    <h2>{{ moduleDefinition?.displayName || 'Terraria Server' }}</h2>
  </div>

  <div class="terraria-content">
    @if (loading && !moduleStatus && !waitingForService) {
      <div class="loading-state">
        <span class="material-icons spinning">sync</span>
        <p>Loading...</p>
      </div>
    } @else if (waitingForService) {
      <div class="loading-state">
        <span class="material-icons spinning">sync</span>
        <p>{{ serviceStatusMessage }}</p>
        <p class="loading-hint">This may take a minute...</p>
      </div>
    } @else if (moduleStatus?.serviceDeployed && moduleStatus?.serviceRunning) {
      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab"
          [class.active]="activeTab === 'status'"
          (click)="switchTab('status')"
        >
          <span class="material-icons">info</span>
          Status
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'logs'"
          (click)="switchTab('logs')"
        >
          <span class="material-icons">terminal</span>
          Logs
        </button>
      </div>

      <!-- Status Tab -->
      @if (activeTab === 'status') {
        <div class="tab-content">
          <div class="status-section">
            <div class="status-item">
              <span class="status-label">Status:</span>
              <span class="status-value running">Running</span>
            </div>
            @if (moduleStatus?.podStatus) {
              <div class="status-item">
                <span class="status-label">Pod:</span>
                <span class="status-value">{{ moduleStatus?.podStatus }}</span>
              </div>
            }
            @for (field of moduleDefinition?.fields; track field.name) {
              @if (moduleStatus?.fieldValues?.[field.name] && field.name !== 'password') {
                <div class="status-item">
                  <span class="status-label">{{ field.label }}:</span>
                  <span class="status-value">{{ getFieldDisplayValue(field, moduleStatus?.fieldValues?.[field.name] || '') }}</span>
                </div>
              }
            }
            <div class="status-item connection-info">
              <span class="status-label">Connect:</span>
              <span class="status-value highlight">{{ getConnectionString() }}</span>
            </div>
          </div>

          @if (error) {
            <div class="error-message">
              <span class="material-icons">error</span>
              {{ error }}
            </div>
          }

          <button class="action-btn danger" (click)="remove()" [disabled]="loading">
            @if (loading) {
              <span class="material-icons spinning">sync</span>
            } @else {
              <span class="material-icons">delete</span>
            }
            Stop Server
          </button>
        </div>
      }

      <!-- Logs Tab -->
      @if (activeTab === 'logs') {
        <div class="tab-content logs-tab">
          <div class="logs-toolbar">
            <button
              class="toolbar-btn"
              [class.active]="autoScroll"
              (click)="toggleAutoScroll()"
              title="Auto-scroll"
            >
              <span class="material-icons">{{ autoScroll ? 'vertical_align_bottom' : 'pause' }}</span>
            </button>
            <button class="toolbar-btn" (click)="clearLogs()" title="Clear logs">
              <span class="material-icons">delete_sweep</span>
            </button>
            <span class="logs-count">{{ logs.length }} lines</span>
          </div>

          <div class="logs-container" #logsContainer>
            @if (logsLoading && logs.length === 0) {
              <div class="logs-loading">
                <span class="material-icons spinning">sync</span>
                Loading logs...
              </div>
            } @else if (logsError && logs.length === 0) {
              <div class="logs-error">{{ logsError }}</div>
            } @else if (logs.length === 0) {
              <div class="logs-empty">No logs available</div>
            } @else {
              @for (line of logs; track $index) {
                <div class="log-line">{{ line }}</div>
              }
            }
          </div>
        </div>
      }
    } @else {
      @if (moduleDefinition?.description) {
        <p class="description">{{ moduleDefinition?.description }}</p>
      }

      <div class="form-grid">
        @for (field of moduleDefinition?.fields; track field.name) {
          <div class="form-group" [class.full-width]="field.name === 'worldsPath'">
            <label [for]="field.name">{{ field.label }}</label>
            @if (field.type === 'select' && field.options) {
              <select
                [id]="field.name"
                [(ngModel)]="fieldValues[field.name]"
                [disabled]="loading"
              >
                @for (option of field.options; track getOptionValue(option)) {
                  <option [value]="getOptionValue(option)">{{ getOptionLabel(option, field.name) }}</option>
                }
              </select>
            } @else {
              <input
                [type]="field.name === 'password' ? 'password' : field.type"
                [id]="field.name"
                [(ngModel)]="fieldValues[field.name]"
                [placeholder]="field.defaultValue || ''"
                [disabled]="loading"
              />
            }
            @if (field.description) {
              <span class="field-hint">{{ field.description }}</span>
            }
          </div>
        }
      </div>

      @if (error) {
        <div class="error-message">
          <span class="material-icons">error</span>
          {{ error }}
        </div>
      }

      <button class="action-btn primary" (click)="deploy()" [disabled]="loading">
        @if (loading) {
          <span class="material-icons spinning">sync</span>
        } @else {
          <span class="material-icons">play_arrow</span>
        }
        Start Server
      </button>
    }
  </div>
</div>
